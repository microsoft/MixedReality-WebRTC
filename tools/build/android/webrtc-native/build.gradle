apply plugin: 'com.android.library'

android {
    compileSdkVersion rootProject.ext.compileSdkVersion
    buildToolsVersion rootProject.ext.buildToolsVersion
    defaultConfig {
        project.archivesBaseName = "mrwebrtc"
        minSdkVersion rootProject.ext.minSdkVersion
        targetSdkVersion rootProject.ext.targetSdkVersion
        versionCode rootProject.ext.versionCode
        versionName rootProject.ext.versionName
        ndk {
            abiFilters "arm64-v8a"
        }
        packagingOptions {
            doNotStrip "*/arm64-v8a/*.so"
        }
        externalNativeBuild {
            cmake {
                cppFlags "-std=c++14 -DANDROID_STL=c++_shared -DMRS_USE_STR_WRAPPER -DMR_SHARING_ANDROID -DWEBRTC_POSIX -DWEBRTC_ANDROID"
            }
        }
    }
    buildTypes {
        // Full debug, including debug symbols for libwebrtc.
        // This produces a very large archive (50+ MB), but is useful
        // to debug issues inside libwebrtc itself.
        fulldebug {
            minifyEnabled false
            useProguard false
            jniDebuggable true
            debuggable true
        }
        // Regular debug with debug symbols for mrwebrtc only.
        // This produces a much more reasonably-sized and lightly optimized
        // archive, and should be the default for debugging.
        debug {
            minifyEnabled false
            useProguard true
            proguardFiles getDefaultProguardFile('proguard-android-optimize.txt'), 'proguard-rules.pro'
            jniDebuggable true
            debuggable true
        }
        // Release version stripped from debug symbols and info
        release {
            minifyEnabled false
            useProguard true
            proguardFiles getDefaultProguardFile('proguard-android-optimize.txt'), 'proguard-rules.pro'
        }
    }
    compileOptions {
        sourceCompatibility JavaVersion.VERSION_1_8
        targetCompatibility JavaVersion.VERSION_1_8
    }
    externalNativeBuild {
        cmake {
            path "./src/main/cpp/CMakeLists.txt"
        }
    }
}

dependencies {
    implementation fileTree(dir: 'libs', include: ['*.jar'])
    implementation 'androidx.appcompat:appcompat:1.1.0'
}

task copyToUnitySample {
    copy {
        from './build/outputs/aar'
        include "*.aar"
        into '../../../../libs/unity/library/Runtime/Plugins/arm64-v8a'
    }    
}

tasks.whenTaskAdded { task ->
    if (task.name == 'externalNativeBuildRelease') {
        task.finalizedBy copyToUnitySample
    } else if (task.name == 'externalNativeBuildDebug') {
        task.finalizedBy copyToUnitySample
    } else if (task.name == 'externalNativeBuildFulldebug') {
        task.finalizedBy copyToUnitySample
    }
}
